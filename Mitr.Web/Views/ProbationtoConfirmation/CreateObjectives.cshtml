@model PTC.ProbationObjectives

<div class="container-fluid">

	<!-- Start -->
	<div class="inner-main  p-3 defult-height">
		<h1 class="heading-one mb-2">Creation of Objective        </h1>

		<div class="row text-clr">
			<div class="col-sm-3 form-group">
				<label>Employee Name </label>
				<p>@Model.EMPName</p>
			</div>
			<div class="col-sm-3 form-group">
				<label>Employee Code </label>
				<p>@Model.EMPCode</p>
			</div>
			<div class="col-sm-3 form-group">
				<label>Designaton </label>
				<p>@Model.Designation</p>
			</div>
			<div class="col-sm-3 form-group">
				<label>Probation End Date</label>
				<p>@Model.ProbationDate</p>
			</div>

		</div>

		@using (Ajax.BeginForm("CreateObjectives", "ProbationtoConfirmation",
						new { src = ViewBag.src },
						new AjaxOptions { HttpMethod = "POST", OnSuccess = "OnSuccessModifyHierarchy", OnBegin = "ShowLoadingDialog()" },
					new { @id = "_ModifyHierarchyFrom" })
					)
		{
			@Html.ValidationSummary(true)
			@Html.AntiForgeryToken()
			@Html.HiddenFor(model => model.EMPID)
			@Html.HiddenFor(model => model.Id)
			<div class="row">
				<div class="col-sm-12 form-group">
					<hr>
					<span class="hr-aps">
						<i class="fas fa-plus"></i>Objectives of the period
					</span>
				</div>
				<div class="col-sm-12">
					<div class="text-right">
						@if (Model.Approved == 0)
						{
							@*<a class="btn mtr-g-grn btn-l ripplelink  " href="" data-toggle="modal" data-target="#adone"><i class="fa fa-plus"></i>Add<span class="ink animate" style="height: 69px; width: 69px; left: -5.5px; top: -17.5px;"></span></a>*@
							<a class="btn mtr-g-grn btn-l ripplelink  " onclick="EditRow(this)"><i class="fa fa-plus"></i>Add<span class="ink animate" style="height: 69px; width: 69px; left: -5.5px; top: -17.5px;"></span></a>
						}
						@*else if(Model.Approved == 0)
							{
								<a class="btn mtr-g-grn btn-l ripplelink isDisabled " href="" data-toggle="modal" data-target="#adone"><i class="fa fa-plus"></i>Add<span class="ink animate" style="height: 69px; width: 69px; left: -5.5px; top: -17.5px;"></span></a>
							}*@

					</div>
					<table class="table  mt-2 vt-a" id="tblObjectives">
						<thead>
							<tr>
								<th width="33" class=" text-center">S.No</th>
								<th width="450">KPA	</th>
								<th>Probation Objective	</th>
								<th width="80">UOM</th>
								<th width="80" class="text-right">Weightage</th>
								@if (Model.Approved == 3 || Model.Approved==1)
								{
									<th width="80" class="text-right">Target</th>
								}
								<th width="100">Action</th>


							</tr>
						</thead>
						<tbody>
							@{ int procount = 0;}
							@if (Model.objectivesperiods != null)
							{
								for (int i = 0; i < Model.objectivesperiods.Count; i++)
								{
									procount++;

									<tr>
										<td class="text-center">@procount</td>
										<td class="hdfobjid">
											@Model.objectivesperiods[i].KPA
											@Html.HiddenFor(modal => modal.objectivesperiods[i].Id)
											@Html.HiddenFor(modal => modal.objectivesperiods[i].Weights)
										</td>
										<td>
											<div class="d-flex">
												<p class="td-text">@Model.objectivesperiods[i].ProbationObjective		</p>
												<i class="fas fa-info-circle td-info w-20" data-placement="top" data-toggle="tooltip" title="" data-original-title="@Model.objectivesperiods[i].Remarks"></i>
											</div>
										</td>


										<td>@Model.objectivesperiods[i].UOMType</td>
										<td class="text-right">@Model.objectivesperiods[i].Weights</td>
										@if (Model.Approved == 3 || Model.Approved == 1)
										{
											<td class="text-right">@Model.objectivesperiods[i].Target</td>
										}
										<td class="text-center">
											@*@if (Model.Approved != 2)*@
											@if (Model.Approved == 0)
											{


												<a class="btnAdd" onclick="EditRow(this)"><i class="fa fa-edit mtr-o-clr"></i>Edit</a><span class="divline">|</span><a data-placement="top" data-toggle="tooltip" title="" data-original-title="Remove" onclick="DeleteRow(this)"><i class="fa fa-trash-alt red-clr"></i></a> }
											else
											{

												<a class="btnAdd isDisabled"><i class="fa fa-edit mtr-o-clr"></i>Edit</a> <span class="divline">|</span> <a data-placement="top" data-toggle="tooltip" title="" data-original-title="Remove" class="isDisabled"><i class="fa fa-trash-alt red-clr"></i></a>}

										</td>



									</tr>
								}
							}





						</tbody>

					</table>
				</div>

				<div class="col-sm-6 mx-auto">
					<div class="row">
						<div class="col-sm-12 form-group">
							<strong>Overall Comment</strong>
							<hr class="mb-2 mt-1">
							@if (Model.Approved == 3)
							{
								@Html.TextAreaFor(model => model.Commentors, new { @class = "form-control h-100 maxSize[1200]", @maxlength = "1200", @placeholder = "Enter Comment", @disabled = "disabled" })
							}
							else if (Model.Approved == 2)
							{
								@Html.TextAreaFor(model => model.Commentors, new { @class = "form-control h-100 maxSize[1200]", @maxlength = "1200", @placeholder = "Enter Comment", @disabled = "disabled" })
							}
							else
							{
								@Html.TextAreaFor(model => model.Commentors, new { @class = "form-control h-100 maxSize[1200]", @maxlength = "1200", @placeholder = "Enter Comment", onkeypress = "return blockSpecialChar(event)" })

							}


						</div>
						@if (Model.Approved == 3 || Model.Approved==1)
						{
							<div class="col-sm-12 form-group">
								<strong>Overall User Comments</strong>
								<hr class="mb-2 mt-1">

								@Html.TextAreaFor(model => model.UserComment, new { @class = "form-control h-100 maxSize[1200]", @maxlength = "1200", @disabled = "disabled" })
							</div>
						}




						@if (Model.resubmitLists != null)
						{
							if (Model.resubmitLists.Count > 0)
							{
								<div class="col-sm-12 form-group">
									<strong>Resubmission Comment</strong>
									<hr class="mb-2 mt-1">
									<table class="table  table-bordered dt-responsive nowrap tbltick mb-0 new_width">
										<tbody>
											<tr>
												<th width="100">Date</th>
												<th width="200">Commented By</th>
												<th>Comment</th>
											</tr>


											@foreach (var item in Model.resubmitLists)
											{
												<tr>
													<td>@item.createdat</td>
													<td>@item.CommentBy</td>
													<td>@item.Comment</td>
												</tr>
											}






										</tbody>
									</table>
								</div>
							}
						}

						<div class="col-sm-12 text-center form-group">
							@if (Model.Approved == 0)
							{
							  <p>After submitting your probation objectives, there is no option to resubmit or modify them.</p>
							  <br />
								<button type="submit" class="btn mtr-o-grn btn-l ripplelink pull-right" name="Command" value="Save"><i class="fas fa-save"></i> Save</button>
								<button type="submit" class="btn mtr-o-grn btn-l ripplelink pull-right" name="Command" value="Submit"><i class="fa fa-paper-plane" aria-hidden="true"></i> Submit</button>}
							@if (Model.Approved == 3)
							{
								<div class="col-sm-12 form-group" id="divres" style="display: none;">
									<strong>Reason for Resubmission <sup>*</sup> </strong>
									<hr class="mb-2 mt-1">
									@Html.TextAreaFor(model => model.ResubmitComment, new { @class = "form-control h-100 maxSize[1200]", @maxlength = "1200", @placeholder = "Enter Comment", onkeypress = "return blockSpecialChar(event)" })
									<div class="text-right">
										<button type="submit" name="Command" value="Resubmit" class="btn mt-2 mtr-o-grn ripplelink"><i class="fas fa-paper-plane"></i> Submit</button>
									</div>
								</div>

								<div class="col-sm-12 text-center">

									<button type="submit" id="btnapproved" class="btn mtr-g-grn btn-l ripplelink pull-right" name="Command" value="Approve"><i class="fas fa-check"></i>Approve</button>
									<button type="button" class="btn blk-gdn-btn btn-l ripplelink" id="btnResubmit"><i class="fas fa-share"></i>Resubmit</button>


								</div>
							}
							<button type="button" class="btn cnl-btn btn-l ripplelink" onclick="ShowLoadingDialog();window.location='@Url.Action("CreationofObjective", new { src = clsApplicationSetting.EncryptQueryString(ViewBag.MenuID.ToString() + "*/ProbationtoConfirmation/CreationofObjective*0*2")  })';"><i class="fas fa-times"></i>Close</button>

						</div>
					</div>
				</div>


			</div>}
	</div>
	<!-- ENd -->

</div>

<div class="modal fade pop-dgn" id="AddModal">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<!-- Modal Header -->
			<div class="modal-header">
				<h4 class="modal-title">
					<i class="fas fa-bullseye"></i> <span id="spnHead">Probation Objectives</span>
				</h4>
				<button type="button" class="close" data-dismiss="modal">&times;</button>
			</div>

			<div class="modal-body ">

				<div id="TagetDivAdd"></div>


			</div>
		</div>

	</div>

</div>
<div class="modal fade scdbg-bg" id="adone">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<!-- Modal Header -->
			<div class="modal-header">
				<h4 class="modal-title">
					<i class="fa fa-plus" aria-hidden="true"></i> <span id="spnHead">Objectives of the period</span>
				</h4>
				<button type="button" class="close" data-dismiss="modal">&times;</button>
			</div>

			<div class="modal-body ">
				<div class="row text-clr">
					<div class="col-sm-4 form-group">
						<label>KPA <sup>*</sup></label>
						@Html.DropDownListFor(x => Model.KPId, new SelectList(Model.kPALists, "ID", "KPAName", Model.KPId), "Select",
new { @class = "form-control  applyselect" })
					</div>
					<div class="col-sm-4 form-group">
						<label>UOM <sup>*</sup></label>
						@Html.DropDownListFor(x => Model.UMId, new SelectList(Model.uMLists, "ID", "Name", Model.UMId), "Select",
new { @class = "form-control  applyselect" })
					</div>


					<div class="col-lg-10 form-group">
						<label>Probation Objective <sup>*</sup></label>
						<textarea class="form-control" placeholder="Enter " id="txtPB" onkeypress="return blockSpecialChar(event)"></textarea>
					</div>
					<div class="col-lg-2 form-group">
						<label>Weightage <sup>*</sup></label>
						<input type="number" placeholder="0" id="txtwght" class="form-control">
					</div>

					<div class="col-lg-12 form-group">
						<label>Remarks</label>
						<textarea class="form-control" placeholder="Enter Remark " id="txtRemark" onkeypress="return blockSpecialChar(event)"></textarea>
					</div>


					<div class="col-lg-12 text-center mt-3">
						<button type="button" data-dismiss="modal" class="btn cnl-btn ripplelink  pull-right"><i class="fas fa-times"></i>Close</button>

						<button type="button" class="btn mtr-g-grn btn-l ripplelink " id="btnrow"><i class="fa fa-plus" aria-hidden="true"></i> Add</button>
					</div>
				</div>

			</div>
		</div>

	</div>

</div>


@section scripts    {
	@System.Web.Optimization.Scripts.Render("~/bundle/unobtrusivejs")
	@Html.IncludeVersionedJs(Url.Content("~/assets/design/scripts/AddInit.js"))

	<script>
		
  


		function blockSpecialChar(e){

        var k;
        document.all ? k = e.keyCode : k = e.which;
		if(k==39){
		event.preventDefault();
		}

        }
		$("#btnResubmit").on("click",  function() {
  $("#divres").toggle(); /*shows or hides #box*/
  	$("#btnEdit").hide();
  /*$(this) refers to the targeted element: #toggleMessage*/
  var text = $(this).text();

  if (text=="Back") { /*if text inside #toggleMessage is Show...*/
    document.getElementById("btnResubmit").innerHTML = "<i class='fas fa-share'></i>Resubmit"; /*Change button text to Hide*/
    $("#btnResubmit").removeClass("cnl-btn")
    $("#btnResubmit").addClass("mtr-o-grn")
		$('#btnapproved').show();

  }
  else {
    document.getElementById("btnResubmit").innerHTML = "<i class='fas fa-long-arrow-alt-left'></i>Back"; /*Change button text to Show*/
    $("#btnResubmit").addClass("btn cnl-btn")
    $("#btnResubmit").removeClass("mtr-o-grn")
			$('#btnapproved').hide();
  }
});


			function EditRow(obj) {
		debugger;
			var ID = parseInt($(obj).closest('tr').find("td.hdfobjid input[type='hidden']").val());
		  if (isNaN(ID)) {
                ID = 0;
            }
		             var EMPId = $("#EMPID").val();
				$.ajax({
					url: "/ProbationtoConfirmation/_ProbationObjectives",
					type: "Get",
		             data: { src: EncryptQueryStringJSON(@ViewBag.MenuID+"*" + "/ProbationtoConfirmation/_ProbationObjectives" + "*" + ID + "*" + 0 + "*" + EMPId + "*" + 0 + "*" + 0 + "*" + 0 + "*" + 0 + "*" + 0) },
					success: function (data) {


						$("#TagetDivAdd").empty();
						$("#TagetDivAdd").html(data);
						$("#AddModal").modal("show");

						$(".applyselect").select2();
						var form = $("form")
							.removeData("validator")
							.removeData("unobtrusiveValidation");
						$.validator.unobtrusive.parse(form);

					},
					error: function (er) {
						console.log(er);
					}
				});

		}
		  $("#btnrow").click(function () {

            $(".notifyjs-wrapper").click();
            var CombinationExist = true;
            var txtProbation = '', txtremark = '';
            var txtProbation = $("#txtPB").val();
            var ddlKPi = $("#KPId").val()
		     var ddlUM = $("#UMId").val()
		    var ddlUMText=$("#UMId option:selected").text();
            var txtremark = $("#txtRemark").val();
	        var txtUmType = ddlUMText;
	        var ddlText=$("#KPId option:selected").text();
	        var txtwt= $("#txtwght").val();
            var InnerHTML = "";
            if (txtProbation == "") {
                $.notify($("#txtPB"), "Hey, you missed this field!", "error");
                $("#txtPB").focus();
                CombinationExist = false;
            }
            if (txtwt == "") {
            $.notify($("#txtwght"), "Hey, you missed this field!", "error");
             $("#txtwght").focus();
            CombinationExist = false;
          }
            if (ddlKPi == "") {
                $.notify($("#KPId"), "Hey, you missed this field!", "error");
                $("#KPId").focus();
                CombinationExist = false;
            }
		    if (ddlUM == "") {
                $.notify($("#UMId"), "Hey, you missed this field!", "error");
                $("#UMId").focus();
                CombinationExist = false;
            }
            if (CombinationExist == true) {
                var Count = parseInt($('#tblObjectives').find("tbody tr").length);
                InnerHTML += "<tr>";
                InnerHTML += "<td><label id='span_" + Count + "'  Name='span_" + Count + "'>" + (Count + 1) + "</label>";
                InnerHTML += "<input type='hidden' id=\"objectivesperiods" + Count + "__KPAID\" name=\"objectivesperiods[" + Count + "].KPAID\" value='" + ddlKPi + "' class = 'hfKPAID' />";
                InnerHTML += "<input type='hidden' id=\"objectivesperiods" + Count + "__ProbationObjective\" name=\"objectivesperiods[" + Count + "].ProbationObjective\" value='" + txtProbation + "' class = 'hfProbation' />";
	            InnerHTML += "<input type='hidden' id=\"objectivesperiods" + Count + "__UOMId\" name=\"objectivesperiods[" + Count + "].UOMId\" value='" + ddlUM + "' class='hfUOMId' /> </td>";
	            InnerHTML += "<input type='hidden' id=\"objectivesperiods" + Count + "__Remarks\" name=\"objectivesperiods[" + Count + "].Remarks\" value='" + txtremark + "' class='hfRemarks' /> </td>";
		        InnerHTML += "<input type='hidden' id=\"objectivesperiods" + Count + "__Weights\" name=\"objectivesperiods[" + Count + "].Weights\" value='" + txtwt + "' class='hfWeights' /> </td>";
               // InnerHTML += "<td><input type='Text' readonly='readonly' class = 'form-control text-right' id=\"objectivesperiods" + Count + "__KPA\" name=\"objectivesperiods[" + Count + "].KPA\" value='" + ddlText + "' /></td>";
		        InnerHTML += "<td>" + ddlText + "</td>";
		        InnerHTML += "<td><div class='d-flex'><p class='td-text'>" + txtProbation + "</p><i class='fas fa-info-circle td-info w-20' data-placement='top' data-toggle='tooltip' title='' data-original-title='" + txtremark + "'></i></div></td>";
	            InnerHTML += "<td class='tw-100'>" + txtUmType + "</td>";
		        InnerHTML += "<td class='tw-100 text-right'>" + txtwt + "</td>";
                InnerHTML += "<td><a onclick='DeleteRow(this)'><i class='fas fa-trash-alt red-clr'></i></a></td> ";
                InnerHTML += "</tr>";
                $('#tblObjectives').append(InnerHTML);
                $('[data-toggle="tooltip"]').tooltip();
                $("#txtPB").val("");
                $("#txtRemark").val("");
		        $("#txtwght").val("");
		        $("#KPId").val('').trigger('change') ;
		        $("#UMId").val('').trigger('change') ;
            }
            else {

            }
        });
		function DeleteRow(obj) {

				var count = 0;
		      var ID = parseInt($(obj).closest('tr').find("td.hdfobjid input[type='hidden']").val());
				var TotalRowCount = $('#tblObjectives').find("tbody tr").length;
		if (isNaN(ID)) {


	         ConfirmMsgBox("Are you sure you want to delete", '', function () {

					$(obj).closest('tr').remove();
					$("#tblObjectives TBODY TR").each(function (i) {
						$(this).closest("tr").find("label").each(function () {
							$(this).attr({
								'id': function (_, id) { var arr = id.split('_'); return id.replace(arr[1], i); },
							});
							$(this).html(i + 1)
						});

						$(this).closest("tr").find("div").each(function () {
							$(this).attr({
								'id': function (_, id) { var arr = id.split('_'); return id.replace(arr[1], i); },
							});
						});


						$(this).closest("tr").find("input").each(function () {
							$(this).attr({
								'id': function (_, id) { return id.replace('_' + (parseInt(i) + 1) + '_', '_' + i + '_'); },
								'name': function (_, name) { return name.replace('[' + (parseInt(i) + 1) + ']', '[' + i + ']'); },
							});

						});

						$(this).closest("tr").find("select").each(function () {
							$(this).attr({
								'id': function (_, id) { return id.replace('_' + (parseInt(i) + 1) + '_', '_' + i + '_'); },
								'name': function (_, name) { return name.replace('[' + (parseInt(i) + 1) + ']', '[' + i + ']'); },
							});

						});

						$(this).closest("tr").find("textarea").each(function () {
							$(this).attr({
								'id': function (_, id) { return id.replace('_' + (parseInt(i) + 1) + '_', '_' + i + '_'); },
								'name': function (_, name) { return name.replace('[' + (parseInt(i) + 1) + ']', '[' + i + ']'); },
							});

						});


						$(this).closest("tr").find("span").each(function () {
							if ($(this).attr("data-valmsg-for")) {
								$(this).attr({
									'data-valmsg-for': function (_, name) { return name.replace('[' + (parseInt(i) + 1) + ']', '[' + i + ']'); },
								});
							}
							if ($(this).attr("for")) {
								$(this).attr({
									'for': function (_, id) { return id.replace('_' + (parseInt(i) + 1) + '_', '_' + i + '_'); },
								});
							}
						});
					});
					var form = $("#_ModifyHierarchyFrom").closest("form");
					form.removeData('validator');
					form.removeData('unobtrusiveValidation');
					$.validator.unobtrusive.parse(form);

				})
	        }
	else{

			ConfirmMsgBox("Are you sure you want to delete", '', function () {

					$(obj).closest('tr').remove();
					$("#tblObjectives TBODY TR").each(function (i) {
						$(this).closest("tr").find("label").each(function () {
							$(this).attr({
								'id': function (_, id) { var arr = id.split('_'); return id.replace(arr[1], i); },
							});
							$(this).html(i + 1)
						});



						$(this).closest("tr").find("input").each(function () {
							$(this).attr({
								'id': function (_, id) { return id.replace('_' + (parseInt(i) + 1) + '_', '_' + i + '_'); },
								'name': function (_, name) { return name.replace('[' + (parseInt(i) + 1) + ']', '[' + i + ']'); },
							});

						});

						$(this).closest("tr").find("select").each(function () {
							$(this).attr({
								'id': function (_, id) { return id.replace('_' + (parseInt(i) + 1) + '_', '_' + i + '_'); },
								'name': function (_, name) { return name.replace('[' + (parseInt(i) + 1) + ']', '[' + i + ']'); },
							});

						});

						$(this).closest("tr").find("textarea").each(function () {
							$(this).attr({
								'id': function (_, id) { return id.replace('_' + (parseInt(i) + 1) + '_', '_' + i + '_'); },
								'name': function (_, name) { return name.replace('[' + (parseInt(i) + 1) + ']', '[' + i + ']'); },
							});

						});


						$(this).closest("tr").find("span").each(function () {
							if ($(this).attr("data-valmsg-for")) {
								$(this).attr({
									'data-valmsg-for': function (_, name) { return name.replace('[' + (parseInt(i) + 1) + ']', '[' + i + ']'); },
								});
							}
							if ($(this).attr("for")) {
								$(this).attr({
									'for': function (_, id) { return id.replace('_' + (parseInt(i) + 1) + '_', '_' + i + '_'); },
								});
							}
						});
					});

			var dataObject = JSON.stringify({
						'ID': ID,
						'Doctype': 'PTC_ProbationObjectivePeriod',
					});
					var data = $.parseJSON($.ajax({
						url: '/CommonAjax/DelRecord_CommonJson',
						type: "post",
						data: dataObject,
						contentType: 'application/json',
						async: false
					}).responseText);
					return data;
					var form = $("#_SetSelfAppraisalFrom").closest("form");
					form.removeData('validator');
					form.removeData('unobtrusiveValidation');
					$.validator.unobtrusive.parse(form);

				})


		}



			}
		function OnSuccessModifyHierarchy(obj) {
			CloseLoadingDialog();
			if (obj.Status) {
		         if(obj.StatusCode==2){

		       SuccessToaster(obj.SuccessMessage);
	     	    window.location.href = obj.RedirectURL
		       }
		else{

		        SuccessToaster(obj.SuccessMessage);
	     	    window.location.href = obj.RedirectURL
		}



			}
			else {
				FailToaster(obj.SuccessMessage);
			}
		}

		function OnSuccess(obj) {
			CloseLoadingDialog();
		$("#AddModal").modal("hide");
			if (obj.Status) {
				SuccessToaster(obj.SuccessMessage);
	          if(obj.StatusCode==2){
		        window.location.reload();
     	   }

			}
			else {
				FailToaster(obj.SuccessMessage);
			}
		}
	</script>
}