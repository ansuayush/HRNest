@model  SalaryStructure.EmployeeSalary.Add
@{
    string MenuID = ViewBag.MenuID.ToString();
    bool ButtonEnabled = Model.CurrentRecord >= Model.TotalRecordsCount ? true : false;


}
<div class="inner-main mb-5">
	<div class="row">
		<div class="col-sm-4">
			<h1 class="heading-one mb-3">Add Employee Salary</h1>
		</div>
	</div>
	@using (Ajax.BeginForm("AddEmployeeSalary", "SalaryStructure",
		   new { src = ViewBag.src },
		   new AjaxOptions { HttpMethod = "POST", OnSuccess = "OnSuccess", OnBegin = "ShowLoadingDialog()", OnFailure = "OnPostFailure()" },
	   new { @id = "AddEmployeeSalaryFrom", @autocomplete = "Off", @enctype = "multipart/form-data" })
	   )
	{
		@Html.HiddenFor(x => Model.id)
		@Html.HiddenFor(x => Model.OldEffectiveDate)
		@Html.HiddenFor(x => Model.Nextid)
		<input type="hidden" id="hfType" name="hfType" value="@ViewBag.Type" />
		@Html.HiddenFor(x => Model.Days)
		<div class="row">
			<div class="col-sm-8">
				<div class="row">
					<div class="col-sm-12 form-group align-self-end ">
						@if (Model.id != 0)
						{
							<div class="act-nxt npdgn" style="">
								<a onclick="NextPrevious(@Model.Empid,@Model.Previousid,@Model.TotalRecordsCount,'Edit')" data-toggle="tooltip" title="Previous"> <i class="fas fa-arrow-left"></i></a>
								<span class="green-clr">@(Model.CurrentRecord) <small>/</small> @(Model.TotalRecordsCount)</span>
								<a onclick="NextPrevious(@Model.Empid,@Model.Previousid,@Model.TotalRecordsCount,'New')" data-toggle="tooltip" title="Next"> <i class="fas fa-arrow-right"></i></a>
							</div>
						}
					</div>
					<div class="col-sm-9 form-group">
						<label>Employee Name</label>
						@if (Model.id != 0)
						{
							<input type="text" placeholder="enter" value="@Model.emp_name" disabled="">
							@Html.HiddenFor(x => Model.Empid)
						}
						else
						{
							@Html.DropDownListFor(n => n.Empid, new SelectList(Model.lstEmp, "ID", "Name", Model.Empid), "Select", new { @class = "form-control  applyselect", OnChange = "ShowEmpDetail()" })
							@Html.ValidationMessageFor(model => model.Empid, "", new { @class = "text-danger" })
						}
					</div>
					<div class="col-sm-3 form-group">
						<label>Employee Code </label>
						<input type="text" placeholder="enter" value="@Model.emp_code" disabled="">
					</div>
					<div class="col-sm-3 form-group">
						<label>Designation </label>
						<input type="text" placeholder="enter" value="@Model.Designation" disabled="">
					</div>

					<div class="col-sm-3 form-group">
						<label>Location </label>
						<input type="text" placeholder="enter" value="@Model.Location" disabled="">
					</div>
					<div class="col-sm-3 form-group">
						<label>Grade </label>
						@Html.DropDownListFor(n => n.Gradeid, new SelectList(Model.lstGrade, "ID", "Name", Model.Gradeid), "Select", new { @class = "form-control  applyselect", @OnChange = "FillRank(this)" })
						@Html.ValidationMessageFor(model => model.Gradeid, "", new { @class = "text-danger" })
					</div>
					<div class="col-sm-3 form-group">
						<label>Role/Rank </label>
						@Html.TextBoxFor(model => model.Role, new { @class = "form-control", @placeholder = "Role", @disabled = "" })
					</div>
					<div class="col-sm-3 form-group">
						<label>Category </label>
						<input type="text" placeholder="enter" value="@Model.EmploymentTerm" disabled="">
					</div>
					<div class="col-sm-3 form-group">
						<label>Sub Category </label>
						@Html.DropDownListFor(n => n.Subcategoryid, new SelectList(Model.lstSubcategory, "ID", "Name", Model.Subcategoryid), "Select", new { @class = "form-control  applyselect", @OnChange = "FillDays(this)" })
						@Html.ValidationMessageFor(model => model.Subcategoryid, "", new { @class = "text-danger" })
					</div>

					<div class="col-sm-3 form-group">
						<label>Steps </label>
						<input type="number" placeholder="" value="" disabled="">
					</div>

					<div class="col-sm-3 form-group">
						<label>Specify Hours </label>
						@Html.TextBoxFor(model => model.WorkingHours, new { @class = "form-control", @placeholder = "Specify Hours", @Type = "Number", @Readonly = "" })
						@Html.ValidationMessageFor(model => model.WorkingHours, "", new { @class = "text-danger" })
					</div>
					<div class="col-sm-3 form-group">
						<label>Structure </label>
						@Html.DropDownListFor(n => n.Structureid, new SelectList(Model.lstStructure, "ID", "Name", Model.Structureid), "Select", new { @class = "form-control  applyselect" })
						@Html.ValidationMessageFor(model => model.Structureid, "", new { @class = "text-danger" })
					</div>

					<div class="col-sm-3 form-group">
						<label>Annual Salary </label>
						@Html.TextBoxFor(model => model.AnnualSalary, new { @class = "form-control text-right", @placeholder = "Annual Salary", @Type = "Number" })
						@Html.ValidationMessageFor(model => model.AnnualSalary, "", new { @class = "text-danger" })
					</div>
					<div class="col-sm-3 form-group">
						<label>Effective Date </label>
						@Html.TextBoxFor(model => model.EffectiveDate, new { @class = "form-control", @placeholder = "", @Type = "Date" })
						@Html.ValidationMessageFor(model => model.EffectiveDate, "", new { @class = "text-danger" })
					</div>

					<div class="mt-3 text-left form-group">
						@if (ButtonEnabled)
						{
							<button type="button" onclick="ListSalaryStructure(0)" class="btn mtr-g-grn" name="Command" value="Add"><i class="fas fa-cogs"></i> Process</button>
						}



					</div>

					<div class="col-sm-12 mt-2">
						<div class=" form-group">
							<hr>
							<span class="hr-aps lgt-text font-sm">Salary Structure</span>
						</div>

					</div>

					<div class="col-sm-9">
						<div id="TagetDiv"></div>

					</div>
					<div class="col-sm-12 mt-3">
						<div class="form-group">
							<hr>
							<span class="hr-aps lgt-text font-sm">Attachment</span>
						</div>
					</div>

					<div class="col-sm-12">
						<div class="table-responsive">
							<table id="TableOtherList" class="table table-striped m-0">
								<thead>
									<tr>
										<th width="50">S.No.</th>
										<th width="250">File</th>
										<th width="100">Download</th>
										<th>Remarks </th>
										<th class="w-33 text-center"></th>
									</tr>
								</thead>
								<tbody>
									@if (Model.lstAttachment != null)
									{
										int QCount = 0;
										for (int i = 0; i < Model.lstAttachment.Count; i++)
										{
											QCount++;
											<tr>
												<td>
													@Html.HiddenFor(model => Model.lstAttachment[i].AttachmentID, new { @class = "hdnID" })
													<label id="span_@QCount" name="span_@QCount">@QCount </label>
												</td>
												<td>
													@Html.TextBoxFor(model => Model.lstAttachment[i].UploadFile, new { @class = "form-control", @type = "file" })
													@Html.ValidationMessageFor(model => Model.lstAttachment[i].UploadFile, "", new { @class = "text-danger" })
												</td>

												<td>
													@if (Model.lstAttachment[i].AttachmentID > 0)
													{
														<a href="~/Attachments/@Model.lstAttachment[i].AttachmentID@Model.lstAttachment[i].FileType" download="@Model.lstAttachment[i].FileName" target="_blank" class="checkgreen anhordowload">Download</a>
													}
												</td>
												<td>
													@Html.TextAreaFor(model => Model.lstAttachment[i].Description, new { @class = "form-control" })
													@Html.ValidationMessageFor(model => Model.lstAttachment[i].Description, "", new { @class = "text-danger" })
												</td>
												<td>
													@if (QCount > 1)
													{
														<a onclick="DeleteRow(this)" class="remove"><i class="fas fa-window-close red-clr" aria-hidden="true"></i></a>
													}
													else
													{
														<a class="disabled"><i class="fas fa-window-close" aria-hidden="true"></i></a>
													}
												</td>
											</tr>
										}
									}

								</tbody>
							</table>
							<div class="col-sm-12 mt-2 text-right">
								<a class="btn green-clr m-0" onclick="AddNewRow(this)"><strong><i class="fas fa-plus"></i>Add Row</strong></a>
							</div>
						</div>
					</div>

					<div class="col-sm-12 mt-3 text-center">
						@if (ButtonEnabled)
						{
							if (Model.IsDraft == 1)
							{
								<button type="submit" name="Command" value="Draft" onclick="return Validate()" class="btn mtr-o-grn btn-l ripplelink "> <i class="fas fa-save"></i>Save</button>
							}
							<button type="submit" name="Command" value="Add" data-toggle="modal" data-target="#mailer" class="btn mtr-o-grn btn-l ripplelink "> <i class="fa fa-paper-plane" aria-hidden="true"></i> Submit </button>
						}

						<button type="button" name="Command" value="Add" class="btn mtr-g-grn btn-l ripplelink " data-toggle="modal" onclick="SalaryStructureDetail()"> <i class="fas fa-info-circle"></i> Detail</button>
						@*<button type="submit" name="Command" value="Add" class="btn red-clr-bg btn-l ripplelink "><i class="far fa-trash-alt"></i>Delete</button>*@
						@*<button type="button" class="btn cnl-btn" onclick="ShowLoadingDialog();window.location='@Url.Action("EmployeeSalaryList", new { src = clsApplicationSetting.EncryptQueryString(ViewBag.MenuID.ToString() + "*/SalaryStructure/EmployeeSalaryList")  })';"><i class="fas fa-times"></i> Close</button>*@
						@Html.CreateAnchor(MenuID, "/SalaryStructure/EmployeeSalaryList", "Close", "btn cnl-btn btn-l ripplelink", "Close", "fas fa-arrow-left", "")
					</div>

				</div>
			</div>
		</div>
	}

</div>
<div class="modal fade" id="detail">
    <div class="modal-dialog modal-xl">
        <div class="modal-content ">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">PACKAGE FOR THE YEAR</span></h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body p-0 ">
                <div id="_SalaryStructureDetail"></div>
                @*@Html.Partial("_SalaryStructureDetail", Model)*@


            </div>
        </div>
    </div>
</div>
@section scripts    {
    @System.Web.Optimization.Scripts.Render("~/bundle/unobtrusivejs")
    @Html.IncludeVersionedJs(Url.Content("~/assets/design/scripts/AddInit.js"))
    <script>
    $(document).ready(function () {
        var Id = $("#id").val();
        ListSalaryStructure(Id)
    });
   	            function ShowEmpDetail() {
                 var ID = Number($("#Empid").val());
                 var MenuID = Number('@MenuID');
                 ShowLoadingDialog();
                 var url = "/SalaryStructure/AddEmployeeSalary?src=" + EncryptQueryStringJSON(MenuID + "*" + "/SalaryStructure/AddEmployeeSalary" + "*" + ID +"*0*Edit");
                 window.location.href = url;
	}
    function ListSalaryStructure(EmpSalaryid) {

        var Empid = $("#Empid").val();
        var AnnualSalary = $("#AnnualSalary").val();
        var Structureid = $("#Structureid").val();
        var Days = $("#Days").val();
        var Hours = $("#WorkingHours").val();
        if (Structureid == undefined || Structureid=="")
        {
            Structureid = 0;
        }
        if (Empid == undefined || Empid == "") {
            Empid = 0;
        }
			$.ajax({
                url: "/SalaryStructure/_SalaryStructure",
				type: "Get",
                data: { EmpSalaryid: EmpSalaryid, src: EncryptQueryStringJSON(@ViewBag.MenuID+"*" + "/SalaryStructure/_SalaryStructure" + "*" + Empid + "*" + AnnualSalary + "*" + Structureid + "*" + Days + "*" + Hours) },
                success: function (data)                {
					$("#TagetDiv").empty();
                    $("#TagetDiv").html(data);
                     var form = $("form")
                .removeData("validator")
                .removeData("unobtrusiveValidation");
                    $.validator.unobtrusive.parse(form);
				},
				error: function (er) {
					alert(er);

				}
			});
    }
    function SalaryStructureDetail() {
        var Id = $("#id").val();
        if (Id == undefined || Id=="")
        {
            Id = 0;
        }
			$.ajax({
                url: "/SalaryStructure/_SalaryStructureDetail",
				type: "Get",
                data: { src: EncryptQueryStringJSON(@ViewBag.MenuID+"*" + "/SalaryStructure/_SalaryStructureDetail" + "*" + Id) },
                success: function (data)                {
                    $("#_SalaryStructureDetail").empty();
                    $("#_SalaryStructureDetail").html(data);
                    $("#detail").modal("show");
				},
				error: function (er) {
					alert(er);
				}
			});
    }
    function AddNewRow(obj) {
        var Table = $(obj).parent("div").parent('div').find('table');
        var TableID = $(Table).attr('ID');

        var LastTRCount = parseInt($('#' + TableID + '').find("tbody tr").length) - 1;
        var $tableBody = $('#' + TableID + '').find("tbody"),
            $trLast = $tableBody.find("tr:last"),
            $trNew = $trLast.clone();
        $trNew.find("td:last").html('<a onclick="DeleteRow(this)" class="remove"><i class="fas fa-window-close red-clr" aria-hidden="true"></i></a>')
        $trNew.find("label").each(function () {
            $(this).attr({
                'id': function (_, id) { var arr = id.split('_'); return id.replace(arr[1], LastTRCount + 1); },
            });
            $(this).html(parseInt($('#' + TableID + '').find("tbody tr").length) + 1)
        });
        $trNew.find("a.anhordowload").each(function (i) {
            $(this).text('')
        });
        $trNew.find("input").each(function (i) {
            $(this).attr({
                'id': function (_, name) { return name.replace('_' + LastTRCount + '_', '_' + (parseInt(LastTRCount) + 1) + '_'); },
                'name': function (_, name) { return name.replace('[' + LastTRCount + ']', '[' + (parseInt(LastTRCount) + 1) + ']'); },
            });
            $(this).val('')
        });
        $trNew.find("input[type='hidden']").each(function (i) {
            $(this).val('0')
        });

        $trNew.find("textarea").each(function (i) {
            $(this).attr({
                'id': function (_, name) { return name.replace('_' + LastTRCount + '_', '_' + (parseInt(LastTRCount) + 1) + '_'); },
                'name': function (_, name) { return name.replace('[' + LastTRCount + ']', '[' + (parseInt(LastTRCount) + 1) + ']'); },
            });
            $(this).val('')
        });
        $trNew.find("span").each(function (i) {
            if ($(this).attr("data-valmsg-for")) {
                $(this).attr({
                    'data-valmsg-for': function (_, name) { return name.replace('[' + LastTRCount + ']', '[' + (parseInt(LastTRCount) + 1) + ']'); }
                });
            }
            if ($(this).attr("for")) {
                $(this).attr({
                    'for': function (_, name) { return name.replace('_' + LastTRCount + '_', '_' + (parseInt(LastTRCount) + 1) + '_'); }
                });
            }
        });

        $trLast.after($trNew);

    }
    function DeleteRow(obj) {
        var Response = 0;
        var ID = $(obj).closest('tr').find('.hdnID').val();
        var Table = $(obj).closest('table');
        var TableID = $(Table).attr('ID');

        ConfirmMsgBox("Are you sure want to delete", '', function () {
            //if (ID) {
            //    var data = DelRecord_Common(ID, '');
            //    if (data.Status) {
            //        Response = 1;
            //    }
            //    else {
            //        FailToaster(data.SuccessMessage);

            //    }
            //}
            //if (Response == 1 || !ID)
            {
                var TotalRowCount = $('#' + TableID + '').find("tbody tr").length;

                $(obj).closest('tr').remove();
                $('#' + TableID + ' TBODY TR').each(function (i) {
                    $(this).closest("tr").find("label").each(function () {
                        $(this).attr({
                            'id': function (_, id) { var arr = id.split('_'); return id.replace(arr[1], i); },
                        });
                        $(this).html(i + 1)
                    });


                    $(this).closest("tr").find("input").each(function () {
                        $(this).attr({
                            'id': function (_, id) { return id.replace('_' + (parseInt(i) + 1) + '_', '_' + i + '_'); },
                            'name': function (_, name) { return name.replace('[' + (parseInt(i) + 1) + ']', '[' + i + ']'); },
                        });
                    });

                    $(this).closest("tr").find("span").each(function () {
                        if ($(this).attr("data-valmsg-for")) {
                            $(this).attr({
                                'data-valmsg-for': function (_, name) { return name.replace('[' + (parseInt(i) + 1) + ']', '[' + i + ']'); },
                            });
                        }
                        if ($(this).attr("for")) {
                            $(this).attr({
                                'for': function (_, id) { return id.replace('_' + (parseInt(i) + 1) + '_', '_' + i + '_'); },
                            });
                        }
                    });
                });
            }
        })
    }



        $(document).ready(function () {
            //ValidateProbation_EndDate();
            //ValidateTermBase();
        });




          function OnSuccess(obj) {
            if (obj.Status) {
                SuccessToaster(obj.SuccessMessage);
                if (obj.AdditionalMessage == "Draft") {
                    window.location.reload();
                }
                else
                {
                    window.location.href = obj.RedirectURL;
                }

            }
            else {
                CloseLoadingDialog();
                FailToaster(obj.SuccessMessage);

            }
        }

        $('#ddRoleIDs').change(function () {
            GetRolesValue()
        });
        function GetRolesValue() {
            var ddRoleIDs = $("#ddRoleIDs").val();
            $("#UserDetails_RoleIDs").val(ddRoleIDs);
        }
    function ShowDetail(CMSID) {
        $("#detail").modal("show");
        @*if (CMSID == undefined)
        {
            CMSID = 0;
        }
			$.ajax({
                url: "/SalaryStructure/_SalaryStructureDetail",
				type: "Get",
                data: { src: EncryptQueryStringJSON(@ViewBag.MenuID+"*" + "/SalaryStructure/_SalaryStructureDetail" + "*" + CMSID) },
                success: function (data)
                {
					$("#TagetDiv").empty();
                    $("#TagetDiv").html(data);
                    $("#detail").modal("show");

				},
				error: function (er) {
					alert(er);

				}
			});*@
            }


       function FillRank(obj) {
        var ID = $(obj).find('option:selected').val();
        if (ID != "") {
            var data = GetGenerateValues(ID, "SS_GRADE_ROLE");
            if (data.Status) {
                $("#Role").val(data.SuccessMessage);
            }
        }
    }

    function FillDays(obj) {
        var ID = $(obj).find('option:selected').val();
        if (ID != "") {
            var data = GetGenerateValues(ID, "SS_SUBCATEGORY_DAYS");
            if (data.Status) {
                $("#Days").val(data.SuccessMessage);
                $("#WorkingHours").val(data.ID);
            }
        }
    }
    function FnCalculateCTC()
    {
        var CTC = "0";
        $('#tblSalaryStructure  TBODY TR').each(function (i) {
            $(this).closest("tr").find(".Amount").each(function () {
                CTC = parseFloat(CTC) + parseFloat($(this).val());
                $(".CTC").val(CTC);
                $("#txtCTC").html(CTC);
            });
        });
    }
    function NextPrevious(Empid, ID, TotalRecordsCount, Type) {
    
		var ID = Number(ID);
        var MenuID = Number('@MenuID');

        if (Type == "Edit") {
                if (ID == 1) { ID = 1; }
                else { ID = ID - 1 }
            }

        if (Type == "New") {
            if (ID < TotalRecordsCount) {
                ID = ID + 1
            }
            else { ID = TotalRecordsCount; }

        }

       
                  ShowLoadingDialog();
                  var url = "/SalaryStructure/AddEmployeeSalary?src=" + EncryptQueryStringJSON(MenuID + "*" + "/SalaryStructure/AddEmployeeSalary" + "*" + Empid +"*0*"+ID +"*"+Type);
                  window.location.href = url;
	}

    </script>
}