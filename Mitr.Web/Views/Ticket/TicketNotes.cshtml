
@model Mitr.Models.Helpdesk.TicketDetails

@section style{
    @System.Web.Optimization.Styles.Render("~/bundle/dataTablecss")
}

@{
    long LoginID = 0;
    long.TryParse(clsApplicationSetting.GetSessionValue("LoginID"), out LoginID);
    bool CanAddNotes = true;
    if (Model.Ticket != null)
    {
        if (Model.Ticket.StatusID == 3)
        {
            CanAddNotes = false;
        }
    }
    if (Model.TicketDeferred.Count>0)
    {
        if (Model.TicketDeferred.Any(x => x.DeferredID == LoginID))
        {
            CanAddNotes = false;
        }
    }
}

<div class="right_col" role="main">
    <div class="row">
        <div class="col-md-12">
            @Html.Partial("HeaderMsg_Partial")
            <h1 class="heading-one "></h1>
        </div>

    </div>
    <div class="card multicard mb-4 shadow-box">
        <div class="card-header blk-gdn-btn ">
            <div><i class="fas fa-ticket-alt"></i> Ticket Details</div>
        </div>
        <div class="card-body p-0">
            @if (Model.Ticket != null)
            {
                <table class="table prfole-info-list table-striped mt-0">
                    <tbody>
                        <tr>
                            <td><strong><i class="fas fa-user"></i>Ticket No</strong></td>
                            <td>@Model.Ticket.TicketNo</td>
                        </tr>
                        <tr>
                            <td><strong><i class="fas fa-user"></i>Category</strong></td>
                            <td>@Model.Ticket.CategoryName</td>
                        </tr>
                        <tr>
                            <td><strong><i class="fas fa-user"></i>Sub Category</strong></td>
                            <td>@Model.Ticket.SubCategoryName</td>
                        </tr>
                        <tr>
                            <td><strong><i class="fas fa-user"></i>Location</strong></td>
                            <td>@Model.Ticket.LocationGroupName</td>
                        </tr>
                        <tr>
                            <td><strong><i class="fas fa-user"></i>Assignee To</strong></td>
                            <td>@Model.Ticket.PrimaryAssigneeName</td>
                        </tr>
                        <tr>
                            <td><strong><i class="fas fa-user"></i>Supervisor</strong></td>
                            <td>@Model.Ticket.SupervisorName</td>
                        </tr>
                        @if (Model.TicketDeferred.Count > 0)
                        {
                            <tr>
                                <td><strong><i class="fas fa-users"></i>Deferred By</strong></td>
                                <td>
                                    @foreach (var item in Model.TicketDeferred)
                                    {
                                        <span> @item.DeferredName</span>
                                    }
                                </td>
                            </tr>
                        }

                        <tr>
                            <td><strong><i class="fas fa-users"></i>Message</strong></td>
                            <td>@Model.Ticket.Message</td>
                        </tr>

                        <tr>
                            <td><strong><i class="fas fa-map-marker-alt"></i>Current Status</strong></td>
                            <td style="color:@Model.Ticket.StatusColor">@Model.Ticket.DisplayName</td>
                        </tr>
                        @if (Model.Ticket.AttachmentID > 0)
                        {
                            <tr>
                                <td><strong><i class="fas fa-map-marker-alt"></i>Attachment</strong></td>
                                <td><a target="_blank" href="~/Attachments/@(Model.Ticket.AttachmentID+""+Model.Ticket.ContentType)"> @Model.Ticket.AttachmentName</a></td>
                            </tr>
                        }
                        <tr>
                            <td><strong><i class="fas fa-map-marker-alt"></i>Created On</strong></td>
                            <td>@Model.Ticket.createdat</td>
                        </tr>
                        <tr>
                            <td><strong><i class="fas fa-map-marker-alt"></i>Created By</strong></td>
                            <td>@Model.Ticket.createdbyName</td>
                        </tr>
                        <tr>
                            <td><strong><i class="fas fa-map-marker-alt"></i>IP Address</strong></td>
                            <td>@Model.Ticket.IPAddress</td>
                        </tr>
                    </tbody>

                </table>
            }
        </div>
    </div>

    <div class="row">

        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="card m-b-20 p-0">
                <div class="card-body p-0">
                    <div>
                     
                        @if (CanAddNotes)
                        {

                            <a data-target="#AddNotesModal" data-toggle="modal" class="btn add-btn ripplelink ">Add Notes</a>

                        }

                    </div>
                    <div class="x_content table-currency m-0">
                        <div class="table-responsive">
                            <table id="datatable-buttons" class="table table-striped table-bordered dt-responsive nowrap tbltick new_width" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                <thead>
                                    <tr>
                                        <th>S.no.</th>
                                        <th>Status</th>
                                        <th>Remarks</th>
                                        <th>Next Date</th>
                                        <th>Inserted Details</th>
                                    </tr>

                                    <tr class="searchbar">
                                        <th class="searchhide"></th>
                                        <th> </th>
                                        <th> </th>
                                        <th> </th>
                                        <th></th>
                                    </tr>

                                </thead>
                                <tbody>
                                    @{ int Count = 0;}
                                    @if (Model.TicketNotesList != null)
                                    {

                                        foreach (Mitr.Models.Helpdesk.TicketNotes item in Model.TicketNotesList)
                                        {
                                            Count++;
                                            <tr>
                                                <td>@Count</td>
                                                <td style="color:@item.StatusColor"> @item.StatusName</td>
                                                <td> @item.Remarks</td>
                                                <td> @item.NextDate</td>
                                                <td class="hrmagin0">
                                                    <div>
                                                        @item.createdat<br>
                                                        @item.createdbyName<br>
                                                        <strong>IP: </strong>@item.IPAddress
                                                    </div>

                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <a onclick="ShowLoadingDialog();window.location='@Url.Action("MyTicket",new { src = clsApplicationSetting.EncryptQueryString(ViewBag.MenuID.ToString() + "*/Ticket/MyTicket")})';">
        <i class="fas fa-times"></i> Back
    </a>

</div>

<div class="modal fade pop-dgn" id="AddNotesModal">
    <div class="modal-dialog modal-md">
        <div class="modal-content">

            <div class="modal-header blk-gdn-btn">
                <h4 class="modal-title"><i class="fas fa-print"></i>Add Notes  </h4>
                <div class="close" data-dismiss="modal">&times;</div>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                @{Html.RenderAction("_AddTicketNotes", "Ticket", new { src = clsApplicationSetting.EncryptQueryString(ViewBag.MenuID.ToString() + "*/Ticket/_AddTicketNotes*" + ViewBag.TicketID) });}
            </div>
        </div>
    </div>
</div>



@section scripts    {
    @System.Web.Optimization.Scripts.Render("~/bundle/dataTablesjs")
    <script src="~/assets/design/Scripts/AddInit.js?v=@clsApplicationSetting.GetWebConfigValue("Version")"></script>
    @System.Web.Optimization.Scripts.Render("~/bundle/unobtrusivejs")
    <script>


        $('#StatusID').bind("change", function () {
            var a = $(this).find("option:selected").val();
            if (a == 4) {
                $(".Forward").show();
            } else {
                $(".Forward").hide();
            }
            if (a == 3) {
                $(".nextDate").hide();
            }
            else {
                 $(".nextDate").show();
            }
        });

        function OnNotesSuccess(obj) {
            if (obj.Status) {
                SuccessToaster(obj.SuccessMessage);
                window.location.reload();
            }
            else {
                swal(obj.SuccessMessage, '');
            }

        }
    </script>
}
